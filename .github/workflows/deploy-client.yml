name: Deploy Client to DigitalOcean

on:
  push:
    branches: [main]
    paths:
      - 'src/MIBO.Client/**'
      - '.github/workflows/deploy-client.yml'
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com
  DO_REGISTRY_NAME: mibo
  CLUSTER_NAME: mibo

jobs:
  deploy-client:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build and push React Client
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/client:latest \
            -t ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/client:${{ github.sha }} \
            --push \
            ./src/MIBO.Client/client/

      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Deploy to Kubernetes
        run: |
          kubectl set image deployment/client \
            client=${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/client:${{ github.sha }} \
            -n default

          kubectl rollout status deployment/client -n default

      - name: Get Service URL
        run: |
          echo "Client deployed!"
          kubectl get svc client -n default