name: Deploy Client

on:
  push:
    branches: ["main", "SCRUM-*", "test", "develop"]
    paths:
      - "src/MIBO.Client/client/**"
      - "k8s/apps/**"
      - "k8s/ci/**"
      - ".github/workflows/deploy-client.yml"
  workflow_dispatch: {}

env:
  NAMESPACE: test
  DEPLOYMENT: mibo-client
  CONTAINER: client
  IMAGE: registry.digitalocean.com/mibo/client

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login DOCR
        run: doctl registry login --expiry-seconds 1200

      - name: Build & Push image (tag = commit SHA)
        run: |
          docker buildx build --platform linux/amd64 \
            -t "${{ env.IMAGE }}:test-${{ github.sha }}" \
            -t "${{ env.IMAGE }}:test-latest" \
            --push \
            ./src/MIBO.Client/client

      # --- Kubernetes auth with DigitalOcean ---
      - name: Setup kubectl
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.CLUSTER_NAME }}
          kubectl version --client=true

      - name: Check if deployment exists
        id: check
        run: |
          if kubectl get deployment ${{ env.DEPLOYMENT }} -n ${{ env.NAMESPACE }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment if not exists
        if: steps.check.outputs.exists == 'false'
        run: |
          kubectl create deployment ${{ env.DEPLOYMENT }} \
            --image=${{ env.IMAGE }}:test-${{ github.sha }} \
            --replicas=1 \
            -n ${{ env.NAMESPACE }}

          kubectl expose deployment ${{ env.DEPLOYMENT }} \
            --port=80 \
            --target-port=80 \
            --type=ClusterIP \
            -n ${{ env.NAMESPACE }}

      - name: Update deployment image
        if: steps.check.outputs.exists == 'true'
        run: |
          kubectl -n "${{ env.NAMESPACE }}" set image deployment/"${{ env.DEPLOYMENT }}" \
            "${{ env.CONTAINER }}"="${{ env.IMAGE }}:test-${{ github.sha }}"

      - name: Wait for rollout
        run: |
          kubectl -n "${{ env.NAMESPACE }}" rollout status deployment/"${{ env.DEPLOYMENT }}"
          kubectl -n "${{ env.NAMESPACE }}" get pods -o wide
