name: Prod - Deploy Backend Services

on:
  push:
    branches: [main]
    paths:
      - 'src/MIBO.IdentityService/**'
      - 'src/MIBO.ApiGateway/**'
      - 'src/MIBO.ConversationService/**'
      - 'src/MIBO.VisualisationService/**'
      - 'src/MIBO.CalendarAgent/**'
      - 'deploy/**'
      - '.github/workflows/prod-backend.yml'
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com
  DO_REGISTRY_NAME: mibo
  CLUSTER_NAME: mibo
  NAMESPACE: prod

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    strategy:
      matrix:
        service:
          - name: identity-service
            path: ./src/MIBO.IdentityService
            dockerfile: Dockerfile
          - name: api-gateway
            path: ./src/MIBO.ApiGateway
            dockerfile: Dockerfile
          - name: conversation-service
            path: ./src/MIBO.ConversationService
            dockerfile: Dockerfile
          - name: visualisation-service
            path: ./src/MIBO.VisualisationService
            dockerfile: Dockerfile
          - name: calendar-agent
            path: ./src/MIBO.CalendarAgent
            dockerfile: Dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push ${{ matrix.service.name }}
        run: |
          docker buildx build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/${{ matrix.service.name }}:${{ github.sha }} \
            -t ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/${{ matrix.service.name }}:latest \
            --push \
            -f ${{ matrix.service.path }}/${{ matrix.service.dockerfile }} \
            ./src

  deploy:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Update image tags in kustomization
        run: |
          cat > deploy/environments/prod/kustomization-override.yaml << EOF
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization

          resources:
            - ./kustomization.yaml

          images:
            - name: ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/identity-service
              newTag: ${{ github.sha }}
            - name: ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/api-gateway
              newTag: ${{ github.sha }}
            - name: ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/conversation-service
              newTag: ${{ github.sha }}
            - name: ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/visualisation-service
              newTag: ${{ github.sha }}
            - name: ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/calendar-agent
              newTag: ${{ github.sha }}

          namespace: ${{ env.NAMESPACE }}
          EOF

      - name: Create prod namespace if not exists
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create image pull secret
        run: |
          kubectl create secret docker-registry do-registry-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} \
            --docker-password=${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }} \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Kustomize and Helm
        run: |
          kubectl apply -k deploy/environments/prod/ -n ${{ env.NAMESPACE }}

      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/identity-service -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/api-gateway -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/conversation-service -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/visualisation-service -n ${{ env.NAMESPACE }} --timeout=300s || true
          kubectl rollout status deployment/calendar-agent -n ${{ env.NAMESPACE }} --timeout=300s || true

      - name: Get deployment status
        if: always()
        run: |
          echo "=== Deployments in prod namespace ==="
          kubectl get deployments -n ${{ env.NAMESPACE }}
          echo "=== Pods in prod namespace ==="
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo "=== Services in prod namespace ==="
          kubectl get services -n ${{ env.NAMESPACE }}

      - name: Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Production deployment ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true