name: Prod - Deploy mibo-client

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/MIBO.Client/client/**"
      - "k8s/apps/10-mibo-client.yaml"
      - ".github/workflows/prod-client.yml"
  workflow_dispatch: { }

env:
  NAMESPACE: mibo
  DEPLOYMENT: mibo-client
  CONTAINER: mibo-client
  IMAGE: registry.digitalocean.com/mibo/client

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Login DOCR
        run: doctl registry login --expiry-seconds 1200

      - name: Build & Push image (tag = commit SHA + latest)
        run: |
          docker buildx build --platform linux/amd64 \
            -t "${{ env.IMAGE }}:${{ github.sha }}" \
            -t "${{ env.IMAGE }}:latest" \
            --push \
            ./src/MIBO.Client/client

      # --- Kubernetes auth with ServiceAccount token (namespaced RBAC) ---
      - name: Setup kubectl (SA token)
        run: |
          set -euo pipefail
          mkdir -p ~/.kube

          echo "${{ secrets.KUBE_CA }}" | base64 -d > ca.crt

          kubectl config set-cluster doks \
            --server="${{ secrets.KUBE_SERVER }}" \
            --certificate-authority="$PWD/ca.crt"

          kubectl config set-credentials ci-deployer --token="${{ secrets.KUBE_TOKEN }}"
          kubectl config set-context prod --cluster=doks --user=ci-deployer
          kubectl config use-context prod

          kubectl version --client=true

      - name: Sanity checks (no cluster-scope calls)
        run: |
          set -euo pipefail
          kubectl -n "${{ env.NAMESPACE }}" get deploy "${{ env.DEPLOYMENT }}" >/dev/null
          kubectl -n "${{ env.NAMESPACE }}" get svc "${{ env.DEPLOYMENT }}" >/dev/null || true

      - name: Apply app manifests (namespaced only)
        run: |
          set -euo pipefail
          kubectl apply -f k8s/apps/10-mibo-client.yaml

      - name: Update deployment image + wait rollout
        run: |
          set -euo pipefail
          kubectl -n "${{ env.NAMESPACE }}" set image deployment/"${{ env.DEPLOYMENT }}" \
            "${{ env.CONTAINER }}"="${{ env.IMAGE }}:${{ github.sha }}"

          kubectl -n "${{ env.NAMESPACE }}" rollout status deployment/"${{ env.DEPLOYMENT }}"
          kubectl -n "${{ env.NAMESPACE }}" get pods -o wide
