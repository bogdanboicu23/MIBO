name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com
  # Update these with your actual values
  DO_REGISTRY_NAME: mibo  # Change this to your registry name
  CLUSTER_NAME: mibo       # Change this to your cluster name

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build and push API Gateway
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/api-gateway:latest ./src/MIBO.ApiGateway/
          docker push ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/api-gateway:latest

      - name: Build and push React Client
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/client:latest ./src/MIBO.Client/client/
          docker push ${{ env.REGISTRY }}/${{ env.DO_REGISTRY_NAME }}/client:latest

      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Deploy to Kubernetes
        run: |
          # Update image in deployment files with actual registry path
          kubectl apply -f k8s/simple/

          # Force rollout to use new images
          kubectl rollout restart deployment/api-gateway -n default
          kubectl rollout restart deployment/client -n default

          # Wait for rollout to complete
          kubectl rollout status deployment/api-gateway -n default
          kubectl rollout status deployment/client -n default

      - name: Get Load Balancer IP
        run: |
          echo "Waiting for Load Balancer IP..."
          kubectl get svc -n default