name: Deploy to DigitalOcean

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production

env:
  REGISTRY: registry.digitalocean.com
  CLUSTER_NAME: mibo

jobs:
  # ============================================
  # Build and Push Microservices to DO Registry
  # ============================================
  build-microservices:
    name: Build Microservices
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - identity-service
          - expense-service
          - notification-service
          - reporting-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push service image
        uses: docker/build-push-action@v5
        with:
          context: ./src/MIBO.${{ matrix.service }}
          file: ./src/MIBO.${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/mibo/${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/mibo/${{ matrix.service }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/mibo/${{ matrix.service }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/mibo/${{ matrix.service }}:buildcache,mode=max

  # ============================================
  # Build and Deploy React Client
  # ============================================
  build-client:
    name: Build React Client
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: ./src/MIBO.Client/client/package-lock.json

      - name: Install dependencies
        working-directory: ./src/MIBO.Client/client
        run: npm ci

      - name: Build application
        working-directory: ./src/MIBO.Client/client
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.API_URL }}
          VITE_ENV: ${{ github.event.inputs.environment || 'staging' }}

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build and push client Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./src/MIBO.Client/client
          file: ./src/MIBO.Client/client/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/mibo/client:latest
            ${{ env.REGISTRY }}/mibo/client:${{ github.sha }}

      # Alternative: Deploy to DigitalOcean Spaces (CDN)
      - name: Deploy to DigitalOcean Spaces
        if: false # Enable this for static hosting
        uses: BetaHuhn/do-spaces-action@v2
        with:
          access_key: ${{ secrets.DO_SPACES_ACCESS_KEY }}
          secret_key: ${{ secrets.DO_SPACES_SECRET_KEY }}
          space_name: mibo-static
          space_region: nyc3
          source: ./src/MIBO.Client/client/dist
          out_dir: /

  # ============================================
  # Deploy to DigitalOcean Kubernetes
  # ============================================
  deploy-to-kubernetes:
    name: Deploy to DOKS
    runs-on: ubuntu-latest
    needs: [build-microservices, build-client]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Save DigitalOcean kubeconfig
        run: doctl kubernetes cluster kubeconfig save ${{ env.CLUSTER_NAME }}

      - name: Update deployment images
        run: |
          # Update microservices
          kubectl set image deployment/api-gateway api-gateway=${{ env.REGISTRY }}/mibo/api-gateway:${{ github.sha }} -n mibo
          kubectl set image deployment/identity-service identity-service=${{ env.REGISTRY }}/mibo/identity-service:${{ github.sha }} -n mibo
          kubectl set image deployment/expense-service expense-service=${{ env.REGISTRY }}/mibo/expense-service:${{ github.sha }} -n mibo
          kubectl set image deployment/notification-service notification-service=${{ env.REGISTRY }}/mibo/notification-service:${{ github.sha }} -n mibo
          kubectl set image deployment/reporting-service reporting-service=${{ env.REGISTRY }}/mibo/reporting-service:${{ github.sha }} -n mibo

          # Update client
          kubectl set image deployment/mibo-client mibo-client=${{ env.REGISTRY }}/mibo/client:${{ github.sha }} -n mibo

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/api-gateway -n mibo
          kubectl rollout status deployment/identity-service -n mibo
          kubectl rollout status deployment/expense-service -n mibo
          kubectl rollout status deployment/notification-service -n mibo
          kubectl rollout status deployment/reporting-service -n mibo
          kubectl rollout status deployment/mibo-client -n mibo

      - name: Run smoke tests
        run: |
          # Wait for services to be ready
          sleep 30

          # Test API Gateway health
          API_URL=$(kubectl get ingress api-gateway -n mibo -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          curl -f http://$API_URL/health || exit 1

          echo "Deployment successful!"

  # ============================================
  # Deploy to App Platform (Alternative for Client)
  # ============================================
  deploy-to-app-platform:
    name: Deploy Client to App Platform
    runs-on: ubuntu-latest
    needs: build-client
    if: false # Enable this if using App Platform instead of K8s for client

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to DigitalOcean App Platform
        uses: digitalocean/app_action@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
          app_name: mibo-client
          spec_path: ./src/MIBO.Client/client/.do/app.yaml

  # ============================================
  # Database Migration
  # ============================================
  database-migration:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: deploy-to-kubernetes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Install EF Core tools
        run: dotnet tool install --global dotnet-ef

      - name: Run migrations
        run: |
          # Connect to DigitalOcean Managed Database
          export ConnectionStrings__DefaultConnection="${{ secrets.DO_DATABASE_URL }}"

          # Run migrations for each service
          dotnet ef database update --project src/MIBO.IdentityService
          dotnet ef database update --project src/MIBO.ExpenseService