name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  DOTNET_VERSION: '9.0'
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/mibo

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
      api-gateway: ${{ steps.filter.outputs.api-gateway }}
      app-host: ${{ steps.filter.outputs.app-host }}
      calendar-agent: ${{ steps.filter.outputs.calendar-agent }}
      conversation-service: ${{ steps.filter.outputs.conversation-service }}
      visualisation-service: ${{ steps.filter.outputs.visualisation-service }}
      weather-data-service: ${{ steps.filter.outputs.weather-data-service }}
      finance-data-service: ${{ steps.filter.outputs.finance-data-service }}
      shared-libs: ${{ steps.filter.outputs.shared-libs }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api-gateway:
              - 'src/MIBO.ApiGateway/**'
              - 'src/MIBO.ApiGateway/Dockerfile'
            app-host:
              - 'src/MIBO.AppHost/**'
              - 'src/MIBO.AppHost/Dockerfile'
            calendar-agent:
              - 'src/MIBO.CalendarAgent/**'
              - 'src/MIBO.CalendarDataService/**'
              - 'src/MIBO.CalendarAgent/Dockerfile'
            conversation-service:
              - 'src/MIBO.ConversationService/**'
              - 'src/MIBO.ConversationService/Dockerfile'
            visualisation-service:
              - 'src/MIBO.VisualisationService/**'
              - 'src/MIBO.VisualisationService/Dockerfile'
            weather-data-service:
              - 'src/MIBO.WeatherDataService/**'
            finance-data-service:
              - 'src/MIBO.FinanceDataService/**'
            shared-libs:
              - 'src/MIBO.Cache.Redis/**'
              - 'src/MIBO.EventBus/**'
              - 'src/MIBO.Storage.Blob/**'
              - 'src/MIBO.Storage.PostgreSQL/**'
              - 'src/MIBO.Observability/**'

      - name: Filter out non-deployable services
        id: set-services
        run: |
          # Get the changes from the filter step
          CHANGES='${{ steps.filter.outputs.changes }}'

          # Filter out shared-libs from the services array
          SERVICES=$(echo "$CHANGES" | jq -r '. - ["shared-libs"]')

          echo "services=$SERVICES" >> $GITHUB_OUTPUT


  build-and-test:
    name: Build and Test Services
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.services != '[]' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: |
          cd src
          dotnet restore MIBO.sln

      - name: Build service
        run: |
          cd src
          SERVICE_NAME=$(echo "${{ matrix.service }}" | sed 's/-service/Service/' | sed 's/-agent/Agent/' | sed 's/-gateway/Gateway/' | sed 's/-host/Host/' | sed 's/-data/Data/' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($i,1,1)),$i)}1' FS=- OFS="")
          PROJECT_PATH="MIBO.${SERVICE_NAME}/MIBO.${SERVICE_NAME}.csproj"

          if [ -f "$PROJECT_PATH" ]; then
            dotnet build "$PROJECT_PATH" --configuration Release --no-restore
          else
            echo "Project not found: $PROJECT_PATH"
            exit 1
          fi

      - name: Run tests
        run: |
          cd src
          SERVICE_NAME=$(echo "${{ matrix.service }}" | sed 's/-service/Service/' | sed 's/-agent/Agent/' | sed 's/-gateway/Gateway/' | sed 's/-host/Host/' | sed 's/-data/Data/' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($i,1,1)),$i)}1' FS=- OFS="")
          TEST_PROJECT="MIBO.${SERVICE_NAME}.Tests/MIBO.${SERVICE_NAME}.Tests.csproj"

          if [ -f "$TEST_PROJECT" ]; then
            dotnet test "$TEST_PROJECT" --configuration Release --no-restore \
              --logger "trx;LogFileName=test-results.trx" \
              --collect:"XPlat Code Coverage" \
              --results-directory ./TestResults
          else
            echo "No test project found for $SERVICE_NAME"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: src/TestResults/

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './src'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: .NET Security Scan
        run: |
          cd src
          dotnet list package --vulnerable --include-transitive

  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [detect-changes, build-and-test]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        include:
          - service: api-gateway
            context: ./src
            dockerfile: ./src/MIBO.ApiGateway/Dockerfile
            changed: ${{ needs.detect-changes.outputs.api-gateway }}
          - service: app-host
            context: ./src
            dockerfile: ./src/MIBO.AppHost/Dockerfile
            changed: ${{ needs.detect-changes.outputs.app-host }}
          - service: calendar-agent
            context: ./src
            dockerfile: ./src/MIBO.CalendarAgent/Dockerfile
            changed: ${{ needs.detect-changes.outputs.calendar-agent }}
          - service: conversation-service
            context: ./src
            dockerfile: ./src/MIBO.ConversationService/Dockerfile
            changed: ${{ needs.detect-changes.outputs.conversation-service }}
          - service: visualisation-service
            context: ./src
            dockerfile: ./src/MIBO.VisualisationService/Dockerfile
            changed: ${{ needs.detect-changes.outputs.visualisation-service }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        if: matrix.changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        if: matrix.changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        if: matrix.changed == 'true' || github.event_name == 'workflow_dispatch'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        if: matrix.changed == 'true' || github.event_name == 'workflow_dispatch'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_CONFIGURATION=Release

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: [build-docker-images, security-scan]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production') || (github.ref == 'refs/heads/develop' && 'staging') || 'dev' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "production" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "KUBECONFIG_SECRET=KUBECONFIG_PROD" >> $GITHUB_ENV
          elif [[ "${{ github.event.inputs.environment }}" == "staging" ]] || [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "KUBECONFIG_SECRET=KUBECONFIG_STAGING" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "KUBECONFIG_SECRET=KUBECONFIG_DEV" >> $GITHUB_ENV
          fi

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Setup Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Configure kubectl
        run: |
          echo "${{ secrets[env.KUBECONFIG_SECRET] }}" | base64 -d > kubeconfig
          echo "KUBECONFIG=$PWD/kubeconfig" >> $GITHUB_ENV

      - name: Deploy with Kustomize
        run: |
          cd deploy/environments/${{ env.ENVIRONMENT }}

          # Update image tags in kustomization
          for service in api-gateway app-host calendar-agent conversation-service visualisation-service; do
            IMAGE_TAG="${{ github.sha }}"
            if [[ "${{ github.ref_type }}" == "tag" ]]; then
              IMAGE_TAG="${{ github.ref_name }}"
            fi

            # Update values files with new image tags
            sed -i "s|tag: .*|tag: ${IMAGE_TAG}|" values-${service}.yaml
          done

          # Build and apply Kustomize configuration
          kustomize build . | kubectl apply -f -

      - name: Verify deployment
        run: |
          kubectl -n mibo rollout status deployment/api-gateway --timeout=5m || true
          kubectl -n mibo rollout status deployment/app-host --timeout=5m || true
          kubectl -n mibo rollout status deployment/calendar-agent --timeout=5m || true
          kubectl -n mibo rollout status deployment/conversation-service --timeout=5m || true
          kubectl -n mibo rollout status deployment/visualisation-service --timeout=5m || true

          kubectl -n mibo get pods
          kubectl -n mibo get services
